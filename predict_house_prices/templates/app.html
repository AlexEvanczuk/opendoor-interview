<head>
	<title>House Pricing Infographic</title>
	<link href="http://www.favicon.cc/logo3d/281717.png" rel="shortcut icon" type="image/png">
	<!-- Loading Bootstrap -->
	<link href="https://d1bfddpgq9qcut.cloudfront.net/static/Flat-UI-master/dist/css/vendor/bootstrap.min.css" rel="stylesheet">
	<!-- Loading Flat UI -->
	<link href="https://d1bfddpgq9qcut.cloudfront.net/static/Flat-UI-master/dist/css/flat-ui.min.css" rel="stylesheet">
	<!-- Include Sidr bundled CSS theme -->
	<link href="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/sidr/stylesheets/jquery.sidr.light.css" rel="stylesheet" >

			
	<!-- Style for Histogram of actual vs predicted price distributions -->
	<style>
		.actualBar rect {
		  fill: #1abc9c;
		  opacity: 0.4;
		  shape-rendering: crispEdges;
		}

		.predictedBar rect {
		  fill: #3498db;
		  opacity: 0.4;
		  shape-rendering: crispEdges;
		}

		.bar text {
		  fill: #34495e;
		}

		.axis path, .axis line {
		  fill: none;
		  stroke: #34495e;
		  shape-rendering: crispEdges;
		}

		/* Add a sweet little fade to our map */

	</style>
</head>

<body>
	<!-- Include jQuery -->
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/jquery.js"></script>
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/jquery-ui.min.js"></script>
	<!-- Include jQuery nav plugin -->
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/jquery.singlePageNav.js"></script>
	<!-- Include mapping engines -->
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/d3.min.js"></script>
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/topojson.js"></script>
	<script src="https://d1bfddpgq9qcut.cloudfront.net/static/javascripts/datamaps.world.min.js"></script>
	<!-- Navbar -->
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-01">
				<span class="sr-only">Toggle navigation</span>
			</button>
			<a class="navbar-brand" href="#">OpenDoor Experiment</a>
		</div>
		
		<div class="collapse navbar-collapse" id="navbar-collapse-01">
			<ul class="nav navbar-nav">
				<li><a href="#about">About</a></li>
				<li><a href="#models">Models</a></li>
				<li><a href="#viz">Visualization</a></li>
				<li><a href="#predict">Prediction</a></li>
				<li><a href="#technical">Technical</a></li>
			</ul>
			<div align="right">
				<div class="loader" title="4">
					<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="30px" viewBox="0 0 24 30" style="enable-background:new 0 0 50 50; margin: 10px 10px 10px 10px;" xml:space="preserve">
						<rect x="0" y="0" width="4" height="10" fill="#1ABC9C">
							<animateTransform attributeType="xml" attributeName="transform" type="translate" values="0 0; 0 20; 0 0" begin="0" dur="0.6s" repeatCount="indefinite" />
   						</rect>
    					<rect x="10" y="0" width="4" height="10" fill="#1ABC9C">
							<animateTransform attributeType="xml" attributeName="transform" type="translate" values="0 0; 0 20; 0 0" begin="0.2s" dur="0.6s" repeatCount="indefinite" />
						</rect>
    					<rect x="20" y="0" width="4" height="10" fill="#1ABC9C">
							<animateTransform attributeType="xml" attributeName="transform" type="translate" values="0 0; 0 20; 0 0" begin="0.4s" dur="0.6s" repeatCount="indefinite" />
						</rect>
					</svg>
				</div>
			</div>
		</div>
	</nav>
	<!-- /Navbar -->

	<!-- About page -->
	<div class="container" id="about">
	
		<div class="demo-row" style="margin-top: 80px;">
			<div class="demo-title">
				<h3>What is this?</h3>
			</div>

			<div class="demo-content demo-content-article">
				<p>An easy to use interactive infographic to predict housing prices in the California area using a variety of statistical methods using <a href="https://www.opendoor.com/">Opendoor</a> data.</p>
				<p>If you like this, feel free to <a href="https://github.com/AlexEvanczuk/opendoor-interview">fork me on github</a> and make any contributions there or to contact me about the project.</p>
			</div>
		</div>

		<div class="demo-row">
			<div class="demo-title">
				<h3>Approach</h3>
			</div>

			<div class="demo-content demo-content-article">
				<p><b>Initial Models</b>
				<p>I use a variety of mathematical techniques to predict the house price.  I begin with straightforward multiple linear regression, using city, zip, state, and type as categorical variables, with beds, baths, and square feet as numerical variables.  I then check interaction effects, by seeing the effect that different house sizes have depending on location and type, by exploring the interactions of beds*city and beds*type.</p>
				<p>Naive bayes and decision trees are employed as well to predict price.  Furthermore, I'm interested in the effect of non-census (i.e. zip code) geographical distribution, so I use k-means clustering on the coordinates of the houses to put them into de facto regions, which can be fed back into the original models.</p>
				<p><b>Supplementary Data</b></b>
				<p>Lastly, I am interested in supplementing my data with data in public repositories.  I step back and consider what information can be decomposed in a way that adds more than the sum of its parts, and I figure that I can create a seperate Django model for city and add several covariates.  City-data.com offers a number of interesting covariates for each US city, and the ones I can include that seem at least marginally interesting are population, median income, population density, demographics, median household value, and distance to nearest city with population > 1,000,000.  Several other measures may seem interesting (or variations of measures such as standard deviation instead of mean), but to avoid overfitting I leave these out.  Of these, I select median income, population density, and median household value.  The code should allow for additional covariates to be added in a very maintanable way.  The additional covariates are scraped using a quickly thrown together web scraper, supplemented by manual additions in the Django admin page where no data is found.</p>
				<p><b>Future Iterations</b></b>
				<p>Future iterations could find a reliable API such as <a href="https://www.data.gov/developers/apis">Data.gov</a>, <a href="http://www.census.gov/data/developers/updates.html">Census.gov</a>, <a href="https://www.sba.gov/about-sba/sba_performance/sba_data_store/web_service_api">SBA.gov</a>, or pages with reliable structure and use web scraping techniques to pull additional information about cities to be put arbitrarily into a database, for procedural model generation.  For example, we might be interested in the location of a house to popular businesses, bars, restaurants, job listings, events, activities, etc.  A flexible web scraping framework would provide the infrastructure to create sophisticated house pricing models.</p>
				<p>Since a considerable portion of city data is unavailable, I am leaving this option disabled for the time being.  It might be worth considering the role <a href="http://en.wikipedia.org/wiki/Imputation_%28statistics%29#Multiple_imputation">imputation</a> can have on the data, where we by some methodology come up with missing data.  This works for some methods such as decision trees, where missing data can itself be a sort of a feature.  Simiarly for categorical data in Naive Bayes or linear regression, missing data might still provide response variable insight.  However, with numerical data, linear regression (and presumably naive bayes) would simply not include a row with missing data in the model fit.</p>
				<p>In summary, I have three top-level models: multiple linear regression, naive bayes (regression) and and a decision tree (regression).  Each of these can also include interactions and/or clustering, for a total of 12 models.</p>
			</div>
		</div>

		<div class="demo-row">
			<div class="demo-title">
				<h3>Presentation</h3>
			</div>

			<div class="demo-content demo-content-article">
				<p>This project is presented as a Django web app hosted on Heroku.  On the backend, I use a PSQL database provided by Heroku, and create a model for each house with each field stored as a property with the respective data type, as well as models for cities and clusters.  These models are pulled into a Django view for the data analysis.  While it may be wise for larger data sets to store model results in server memory (or at least as a set of parameters for easy model recreation), in this case I recreate the model on every page load.  This ensures that the model always incorporates all data in the database.</p>
				<p>The page is laid out with four views: about, models, visualization, and prediction.  The about page  outlines the purpose of the project.  The models page allows you to see the mathematical output of your model's parameters and visualize the model on graphs and charts.  The visualization page presents a map which uses D3 to display the results visually.  Every node is a house.  Nodes are placed based on longitude and latitude, sized according to (actual) price, and colored according to type.  Hover over nodes to display each property of a node, as well as its predicted price.</p>
				<p>Lastly, I offer the ability to predict the price of a new house.  In the input new house box, you can input the values of each property of the house, and it will output the predicted price of that house, as well as place the new house on the map in black.  The input fields only allow for domain selection for previously predicted categories, or continuous values within one standard deviation of the domain.</p>
			</div>
		</div>

		<div class="demo-row">
			<div class="demo-title">
				<h3>Design</h3>
			</div>

			<div class="demo-content demo-content-article">
				<p>I used the flat-ui user interface kit with user interactions designed mostly manually to create this web-app. </p>
				<p>Simple is good.</p>
			</div>
		</div>
	</div>
	<!-- /About page -->

	<!-- Models page -->
	<div class="container" id="models">
		<div class="demo-row" style="margin-top: 80px;">
			<div class="demo-title">
				<h3>Models</h3>
			</div>
			<p>Select Model</p>
			<label class="radio" for="radio1">
				<input type="radio" name="optionsRadios1" value="linear" id="radio1" data-toggle="radio" class="custom-radio"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
				<b>Multiple Linear Regression</b>
			</label>
			<label class="radio" for="radio2">
				<input type="radio" name="optionsRadios1" value="bayes" id="radio2" data-toggle="radio" class="custom-radio"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
				<b>Naive Bayes</b>
			</label>
			<label class="radio" for="radio3">
				<input type="radio" name="optionsRadios1" value="tree" id="radio3" data-toggle="radio" class="custom-radio"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
				<b>Decision Trees</b>
			</label>
			<label class="checkbox" for="interactionsCheckbox">
			<input type="checkbox" value="interactions" id="interactionsCheckbox" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>Interactions (for MLR)</label></li>
			<label class="checkbox" for="clusteringCheckbox">
			<input type="checkbox" value="clustering" id="clusteringCheckbox" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>Clustering</label></li>
			<label class="checkbox" for="supplementaryCheckbox">
			<input type="checkbox" value="supplementary" id="supplementaryCheckbox" data-toggle="checkbox" disabled class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>Supplementary City Data</label></li>

			<div class="demo-content demo-content-article">
				<p>Model parameters (note that categorical variables are encoded)</p>
				<pre class="prettyprint" id='modelData'>Once data is loaded, model data will go here.</pre>
				<p>Average price difference</p>
				<pre class="prettyprint" id='avgDiff'>Once data is loaded, model data will go here.</pre>
				<p>Sum of squared price difference</p>
				<pre class="prettyprint" id='ssDiff'>Once data is loaded, model data will go here.</pre>
				<p>Additional Metrics</p>
				<pre class="prettyprint" id='metrics'>Once data is loaded, model data will go here.</pre>
				<p>Histogram of actual vs. predicted prices  (light green is actual, light blue is predicted, and turqouise is their intersection)</p>
				<pre class="prettyprint" id='histogram'>Once data is loaded, model data will go here.</pre>
			</div>
		</div>

	</div>
	<!-- /Models page -->

	<!-- Visualization page -->
	<div class="container" style="height:500px;" id="viz">
		<div class="demo-row" style="margin-top: 80px;">
			<div class="demo-title">
				<h3>Visualization</h3>
			</div>

			<div class="demo-content demo-content-article">
			</div>
			<div class="container" id="vizData">
				Hover over bubbles to find detailed house information.  Click on a node to recenter map.
			</div>
		</div>
		<button class="btn btn-embossed btn-primary" style="position:absolute; margin-top: 10px; margin-left: 10px;" id="zoomin">Zoom in</button>
		<button class="btn btn-embossed" style="position:absolute; margin-top: 60px; margin-left: 10px;" id="zoomout">Zoom out</button>
		<div style="pointer-events: none; position:absolute; margin-top: 110px; margin-left: 10px;" id="mapData">
		</div>
	</div>

	<!-- /Visualization page -->

	<!-- Prediction page -->
	<div class="container" id="predict">
		<div class="demo-row" style="margin-top: 80px;">
			<div class="demo-title">
				<h3>Prediction</h3>
			</div>
 
			<div class="demo-content demo-content-article" style="display:inline; width=100%;">
				<p>Input house fields here to predict their price!<br>Note that we only allow previously trained categorical data to be inputted, and a specified continuous range for each field.  This is in order to ensure that we are predicting mostly within the range (interpolation) without too much irresponsible extrapolation.<br>Click on a field to see a valid data range.</p>
				<div>
					<div style="float:left">
						<div class='predictInput'><input type="text" placeholder="Street" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="City" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Zip Code" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="State" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Beds" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Baths" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Square Feet" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="House Type" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Sale Date" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Latitude" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
						<div class='predictInput'><input type="text" placeholder="Longitude" class="form-control" style="width:300px; margin-bottom: 10px;"/></div>
					</div>
					<div style="float:left; padding-left: 15px; width: 800px; word-wrap: break-word;" id="validData">
						<script>
							// Here we create the click events for each of our fields to list the valid data range
							$("[placeholder]").focus(function() {
									switch($(this).attr('placeholder')){
										case 'Street':
											$("#validData").html("Any string will do")
											break;
										case 'City':
											$("#validData").html("Type any of the following (case-sensitive):<br><p style='overflow-y: auto; overflow-x: auto;'> " + uniqueCities.join([separator = ', ']) + "</p>")
											break;
										case 'Zip Code':
											$("#validData").html("Type any of the following (case-sensitive):<br><p style='overflow-y: auto; overflow-x: auto;'> " + uniqueZipCodes.join([separator = ', ']) + "</p>")
											break;
										case 'State': 
											$("#validData").html("Type any of the following (case-sensitive):<br><p style='overflow-y: auto; overflow-x: auto;'> " + uniqueStates.join([separator = ', ']) + "</p>")
											break;
										case 'Beds':
											$("#validData").html("Numerical low ranges are calculated by taking the maximum of zero or one standard deviation below the lowest value in our data set and rounding.<br>" +
												"Numerical high ranges are calculated by adding one standard deviation to the maximum value in our data set and rounding.<br>" +
												"Please enter a number between " + bedRange[0] + " and " + bedRange[1] + ".")
											break;
										case 'Baths':
											$("#validData").html("Numerical low ranges are calculated by taking the maximum of zero or one standard deviation below the lowest value in our data set and rounding.<br>" +
												"Numerical high ranges are calculated by adding one standard deviation to the maximum value in our data set and rounding.<br>" +
												"Please enter a number between " + bathsRange[0] + " and " + bathsRange[1] + ".")
											break;
										case 'Square Feet':
											$("#validData").html("Numerical low ranges are calculated by taking the maximum of zero or one standard deviation below the lowest value in our data set and rounding.<br>" +
												"Numerical high ranges are calculated by adding one standard deviation to the maximum value in our data set and rounding.<br>" +
												"Please enter a number between " + squareFeetRange[0] + " and " + squareFeetRange[1] + ".")
											break;
										case 'House Type':
											$("#validData").html("Type any of the following (case-sensitive):<br><p style='overflow-y: auto; overflow-x: auto;'> " + uniqueHouseTypes.join([separator = ', ']) + "</p>")
											break;
										case 'Sale Date':
											$("#validData").html("Any string will do")
											break;
										case 'Latitude':
											$("#validData").html("Any decimal number between -90.0 and 90.0")
											break;
										case 'Longitude':
											$("#validData").html("Any decimal number between -180.0 and 180.0")
											break;
										default:
											// Do nothing											
									}
							});
							$("[placeholder]").focusout(function() {
								input = $(this).val()
								goodInput = false
								switch($(this).attr('placeholder')){
										case 'Street':
											goodInput = input.length > 0
											break;
										case 'City':
											goodInput = $.inArray(input, uniqueCities) != -1
											break;
										case 'Zip Code':
											goodInput = $.inArray(input, uniqueZipCodes) != -1
											break;
										case 'State': 
											goodInput = $.inArray(input, uniqueStates) != -1
											break;
										case 'Beds':
											goodInput = (bedRange[0] <= input && input <= bedRange[1] && input != "")
											break;
										case 'Baths':
											goodInput = (bathsRange[0] <= input && input <= bathsRange[1] && input != "")
											break;
										case 'Square Feet':
											goodInput = (squareFeetRange[0] <= input && input <= squareFeetRange[1] && input != "")
											break;
										case 'House Type':
											goodInput = $.inArray(input, uniqueHouseTypes) != -1
											break;
										case 'Sale Date':
											goodInput = input.length > 0
											break;
										case 'Latitude':
											goodInput = (-90.0 <= input && input <= 90.0 && input != "")
											break;
										case 'Longitude':
											goodInput = (-180.0 <= input && input <= 180.0 && input != "")
											break;
										default:
								}

								if(goodInput) { 
									$(this).parent().removeClass('has-error')
									$(this).parent().addClass('has-success')
								} else {
									$(this).parent().removeClass('has-success')
									$(this).parent().addClass('has-error')
								}
							});
						</script>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="container">
		<blockquote id="predictionResult"></blockquote>
		<button class="btn btn-hg btn-primary disabled" id="predictButton">Predict</button>
		
	</div>
	<!-- /Prediction page -->

	<!-- Scripts -->
	<script>
		$(document).ready(function() {
			$('#navbar-collapse-01').singlePageNav({'easing':'easeOutQuint'});

			// Set a loading icon while any data is being loaded for a better user experience
			$(document).bind("ajaxSend", function(){
  				$(".loader").show()
 			}).bind("ajaxComplete", function(){
  				$(".loader").hide()
 			});
			// Set origin URL (to switch from local to production environments)
			origin = 'http://opendoor-interview.herokuapp.com/'
			//origin = 'http://127.0.0.1:8000'
			//origin = 'http://0.0.0.0:5000'
			
			// Initial map parameters
			scale = 500
			longitude = -115.478851
			latitude = 38.575764

			// Load house bubble data
			$.ajax({
        		url: origin + '/returnhousebubbles',
       			success: function(response) {
					houseBubbles = JSON.parse(response)
					// Draw map for first time
					reDrawMap()
        		}
    		});

    		// Load cluster data
    		$.ajax({
        		url: origin + '/returnclusters',
       			success: function(response) {
					clusters = JSON.parse(response)
        		}
    		});

    		// Some basic math functions for returning a valid range
    		function standardDeviation(values){
  				var avg = average(values);
  
  				var squareDiffs = values.map(function(value){
					var diff = value - avg;
					var sqrDiff = diff * diff;
    				return sqrDiff;
 				});
  
				var avgSquareDiff = average(squareDiffs);
 
				var stdDev = Math.sqrt(avgSquareDiff);
				return stdDev;
			}
 
			function average(data){
				var sum = data.reduce(function(sum, value){
					return sum + value;
				}, 0);
 
				var avg = sum / data.length;
				return avg;
			}

			function returnRange(arr){
				var min = Math.min.apply(null, arr)
				var max = Math.max.apply(null, arr)
				var stdDev = standardDeviation(arr)
				var lowRange = Math.max(0, Math.ceil(min - stdDev))
				var highRange = Math.ceil(max + stdDev)
				return [lowRange, highRange]
			}

    		// Load house data to provide ranges on prediction input
			$.ajax({
        		url: origin + '/returnhouses',
       			success: function(response) {
					houses = response
					cities = []
					zipCodes = []
					states = []
					beds = []
					baths = []
					squareFeet = []
					houseType = []

					$(houses).each(function(){ 
						cities.push($(this).attr('fields').city) 
						zipCodes.push($(this).attr('fields').zip_code) 
						states.push($(this).attr('fields').state) 
						beds.push($(this).attr('fields').beds) 
						baths.push($(this).attr('fields').baths) 
						squareFeet.push($(this).attr('fields').square_feet) 
						houseType.push($(this).attr('fields').house_type) 
					});
					
					uniqueCities = $.unique(cities).sort()
					uniqueZipCodes = $.unique(zipCodes).sort()
					uniqueStates = $.unique(states).sort()
					uniqueHouseTypes = $.unique(houseType).sort()

					bedRange = returnRange(beds)
					bathsRange = returnRange(baths)
					squareFeetRange = returnRange(squareFeet)
        		}
    		});

			// Boiler plate functions to change/get model data
			function changeModelData(model){
				text = ''
       			for(param in model.modelcoefficients){
       				text += param + ": " + model.modelcoefficients[param]
       				text += '\n'
       			}
       			
       			$("#modelData").text(text)
       				.css('height','300px')
       				.css('overflow-y', 'auto')

       			$("#avgDiff").text(model.averageDiff)

       			$("#ssDiff").text(model.ssDiff)

				text = ''
       			for(param in model.metrics){
       				text += param + ": " + model.metrics[param]
       				text += '\n'
       			}
       			$("#metrics").text(text)

       			// Change prediction output and add bubble
       			if(model.modelPrediction == null){
       				$("#predictionResult").text("")
       			// If no model is selected, inform the user
       			} else { 
       				text = "Using data trained with your currently selected model, <br>we predict this house will sell for: <b>" + 
       				Math.ceil(model.modelPrediction) + 
       				"</b><br>Scroll up to see this house outputted in the map (in black)"
       				newHouse = {'zip_code': $('[placeholder="Zip Code"]').val(),
       					'city': $('[placeholder="City"]').val(),
						'house_type': $('[placeholder="House Type"]').val(),
						'fillKey': 'prediction',
						'radius': Math.sqrt(model.modelPrediction) / 100,
						'actual_price': 'Unknown',
						'beds': $('[placeholder="Beds"]').val(), 
						'baths': $('[placeholder="Baths"]').val(),
						'square_feet': $('[placeholder="Square Feet"]').val(),
						'predicted_price': model.modelPrediction,
						'latitude': $('[placeholder="Latitude"]').val(),
						'longitude': $('[placeholder="Longitude"]').val()}
       				houseBubbles.push(newHouse)
       				reDrawMap()
       				$('blockquote').html(text)
       			}

       			// Generate a histogram to compare prediction vs actual values
       			$("#histogram").text('')

								var actualValues = model.actualList
				var predictedValues = model.predictedList

				var margin = {top: 10, right: 30, bottom: 30, left: 30},
				    width = 960 - margin.left - margin.right,
				    height = 500 - margin.top - margin.bottom;

				var x = d3.scale.linear()
				    .domain([0, 1000000])
				    .range([0, width]);

				// Generate a histogram using twenty uniformly-spaced bins.
				var actualPriceData = d3.layout.histogram()
				    .bins(x.ticks(20))
				    (actualValues);

				var preditedPriceData = d3.layout.histogram()
				    .bins(x.ticks(20))
				    (predictedValues);

				var y = d3.scale.linear()
				    .domain([0, d3.max(actualPriceData, function(d) { return d.y; })])
				    .range([height, 0]);
				
				var commasFormatter = d3.format(",.0f")
				var xAxis = d3.svg.axis()
				    .scale(x)
				    .orient("bottom")
				   	.tickFormat(function(d) { return "$" + commasFormatter(d) }); 

				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left");

				var svg = d3.select("#histogram").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
				 	.append("g")
				    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				// Add actual prices
				var bar = svg.selectAll(".actualBar")
				    .data(actualPriceData)
				  	.enter().append("g")
				    .attr("class", "actualBar")
				    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

				bar.append("rect")
				    .attr("x", 1)
				    .attr("width", x(actualPriceData[0].dx) - 1)
				    .attr("height", function(d) { return height - y(d.y); });

				// Add predicted prices
				var bar = svg.selectAll(".predictedBar")
				    .data(preditedPriceData)
				  	.enter().append("g")
				    .attr("class", "predictedBar")
				    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

				bar.append("rect")
				    .attr("x", 1)
				    .attr("width", x(preditedPriceData[0].dx) - 1)
				    .attr("height", function(d) { return height - y(d.y); });

				svg.append("g")
				    .attr("class", "x axis")
				    .attr("transform", "translate(0," + height + ")")
				    .call(xAxis);

				svg.append("g")
					.attr("class", "y axis")
				    .call(yAxis);

			}

			/* ['houseCovariates':[
				'zip': house.zip_code, 
				'state': house.state, 
				'type': house.house_type,
				'beds': house.beds, 
				'baths': house.baths, 
				'sqfeet': house.square_feet
				]
			'modelType': ['linear', 'bayes', 'tree'],
			'interactions': ['true','false'],
			'clustering': ['true', 'false'],
			'supplementary: ['true', 'false']
			*/
			function getModelData(modelType, interactions, clustering, supplementary, houseCovariates){
				$.ajax({
        				url: origin + '/linearmodel',
        				dataType: "json",
        				data: {'houseCovariates': houseCovariates,
								'modelType': modelType,
								'interactions': interactions,
								'clustering': clustering,
								'supplementary': supplementary},
       					success: function(response) {
       						changeModelData(response)
       						reDrawMap()
       						return(response)
       					},
       					error: function (xhr, ajaxOptions, thrownError) {
     						console.log(xhr.status);
        					console.log(thrownError);
      					}

       				});
			}

    		// Pull in model parameters for each of our models upon radio change or checkbox events events
       		$(':radio').on('change', function() {
       			var modelType = $(':radio:checked').val()
       			var interactions = $('#interactionsCheckbox').is(":checked")
       			var clustering = $('#clusteringCheckbox').is(":checked")
       			var supplementary = $('#supplementaryCheckbox').is(":checked")
       			getModelData(modelType, interactions, clustering, supplementary, {})
			});

       		$(':checkbox').on('change', function() {
       			var modelType = $(':radio:checked').val()
       			var interactions = $('#interactionsCheckbox').is(":checked")
       			var clustering = $('#clusteringCheckbox').is(":checked")
       			var supplementary = $('#supplementaryCheckbox').is(":checked")

       			// If clustering is checked, add a clusterdata info box if one doesn't already exist, 
       			if($(this).val() == 'clustering') {
       				if(clustering == true) {
       					text = ''
       					for(c in clusters){
       						text += "Cluster Index " + clusters[c].cluster + ": " + clusters[c].latitude + ", " + clusters[c].longitude
       						text += '\n'
       					}
       			
       					$('#models').append('<div id="clusterData"><p>The latitude and longitude for the centroid of each cluster (also added to the map below)</p>' +
							"<pre class=''prettyprint'>" + text + "</pre><div>")
       				} else {
       					$('#clusterData').remove()
       				}
       			}
       			
       			getModelData(modelType, interactions, clustering, supplementary, {})
			});

    		// Load map and associated functions
			function reDrawMap(){
				$('.datamap').remove()
				var map = new Datamap({
					element: document.getElementById('viz'),
					geographyConfig: {
						popupOnHover: true,
						highlightOnHover: false
					},
					height:'380px',
					bubblesConfig: {
						popupOnHover: true
					},
					fills: {
						'defaultFill': '#ABDDA4',
						'Condo': '#3498db',
						'Multi-Family': '#e74c3c',
						'Residential': '#9b59b6',
						// Refers to unknown house type
						'Unkown': '#ecf0f1',
						'prediction': '#000000',
						'cluster': '#7f8c8d'
					},
						
					// Zoom in on Sacramento, CA
					setProjection: function(element) {
						var projection = d3.geo.equirectangular()
							.center([longitude, latitude])
							//.rotate([4.4, 0])
							.scale(scale)
							.translate([element.offsetWidth / 2, element.offsetHeight / 2]);
						var path = d3.geo.path()
							.projection(projection);
						return {path: path, projection: projection};
					},
				});

				// Add as sweet little datamap fade
				// $(".datamap").css('-webkit-mask-image', '-webkit-gradient(linear, left 90%, left bottom, from(rgba(0,0,0,1)), to(rgba(0,0,0,0)))')
			
				// Populate map with bubbles (different bubbles if clustering is on or off)
       			var clustering = $('#clusteringCheckbox').is(":checked")
       			if(clustering) { 
					map.bubbles(houseBubbles.concat(clusters), {
						popupTemplate: function(geo, data) {
							// If the bubble is a cluster, pop info is different
							if(data.fillKey == 'cluster') {
								$("#mapData").html("<b>Cluster Index: </b>" + data.cluster +
									"<br><b>Lat, long:</b> " + latitude + ", " + longitude)
								return null							
							} else { 
								$("#mapData").html("<b>Lat, long:</b> " + 
								latitude + ", " + longitude + "<br><b>Beds:</b> " +
								data.beds + "<br><b>Baths:</b> " + data.baths + "<br><b>House Type:</b> " + 
								data.house_type + "<br><b>Square Feet:</b> " + data.square_feet + "<br><b>Zip:</b> " + 
								data.zip_code + "<br><b>City: </b>" + data.city + 
								"<br><b>Actual Price:</b> " + data.actual_price + "<br><b>Predicted Price:</b> " + data.predicted_price)
								return null
							}
						}
					});
       			} else {
					map.bubbles(houseBubbles, {
						popupTemplate: function(geo, data) {
							$("#mapData").html("<b>Lat, long:</b> " + 
								latitude + ", " + longitude + "<br><b>Beds:</b> " +
								data.beds + "<br><b>Baths:</b> " + data.baths + "<br><b>House Type:</b> " + 
								data.house_type + "<br><b>Square Feet:</b> " + data.square_feet + "<br><b>Zip:</b> " + 
								data.zip_code + "<br><b>City: </b>" + data.city + 
								"<br><b>Actual Price:</b> " + data.actual_price + "<br><b>Predicted Price:</b> " + data.predicted_price)
							return null
						}
					});
				}

				// Add bubble click and hover functionality
				$(".datamaps-bubble").click(function() {
					data = JSON.parse($(this).attr('data-info'))
					latitude = data.latitude
					longitude = data.longitude
					reDrawMap()
				});

			}

			// Boiler plate function for changing circle radii
			function adjustBubbleRadius(alpha){
				for(bubble in houseBubbles){
					houseBubbles[bubble]['radius'] *= scale * alpha
				}
			}

			// Add button zoom handlers
    		$("#zoomin").click(function() {
    			// Adjust the bubble size proportional to zoom level
    			scale *= 2 
				reDrawMap()
			});

    		$("#zoomout").click(function() {
    			scale /= 2
				reDrawMap()
			});

			// When button is pressed, validate fields and send data to getModelData
			// Note that a bubble is automatically added in getmodeldata if a prediction is 
			// returned.  It might be better to separate this functionality out.
			$('#predictButton').click(function() {
				// Validate fields

				// Get model prediction
				var modelType = $(':radio:checked').val()
		       	var interactions = $('#interactionsCheckbox').is(":checked")
		       	var clustering = $('#clusteringCheckbox').is(":checked")
		       	var supplementary = $('#supplementaryCheckbox').is(":checked")
		       	var houseCovariates = {'zip': $('[placeholder="Zip Code"]').val(), 
					'city': $('[placeholder="City"]').val(), 
					'state': $('[placeholder="State"]').val(), 
					'type': $('[placeholder="House Type"]').val(),
					'beds': $('[placeholder="Beds"]').val(), 
					'baths': $('[placeholder="Baths"]').val(), 
					'sqfeet': $('[placeholder="Square Feet"]').val()
					}
				if(typeof $(':radio:checked').val() == 'undefined'){
       				$('blockquote').text("Please select a model.")
       			} else {
		       		getModelData(modelType, interactions, clustering, supplementary, houseCovariates)       				
       			}
			});

			// Set an interval to check if all input fields are correctly filled out.
			// If so, enable button.  Else, disable button
			setInterval(function () {
				if($('.has-success').length == 11) {
					$('#predictButton').removeClass('disabled')
				} else {
					$('#predictButton').addClass('disabled')
				}}, 500)
		});
	</script>
	<!-- /Scripts -->

	<!-- Technical notes page -->
	<div class="container" style="height:500px;" id="technical">
		<div class="demo-row" style="margin-top: 80px;">
			<div class="demo-title">
				<h3>Technical Notes and Improvements</h3>
			</div>

			<div class="demo-content demo-content-article">
				<p><b>Dependencies (and related issues)</b></p>
				<p>Here is a brief list of packages or resources used, with reflection on their utility.</b>
				<p><a href="http://designmodo.github.io/Flat-UI/">FlatUI - Free User Interface Kit</a>: Relatively simple to use, and provides for a clean, simple, modern design.</p>
				<p><a href="http://d3js.org">D3.js - Data-Driven Documents</a>: Great resource to create histograms and other charts.
				<p><a href="http://www.city-data.com/city/Rio-Linda-California.html">CityData - Information about different cities</a>: Semi-structured city data.</p>
				<p><a href="http://datamaps.github.io/">DataMaps - Visual city data</a>: Extremely easy to use, perhaps not flexible enough for more advanced usage, but could possibly modify the source.</p>
				<p><a href="http://scikit-learn.org/">Sci-Kit - Machine learning package for python</a>: Would probably recommend any future projects insource machine learning algorithms (see below).</p>
				<p><a href="https://devcenter.heroku.com/articles/getting-started-with-django">Heroku - Hosting for (Django) webapps</a>: Convenient, not sure about its use at a larger scale.</p>
				<p><a href="http://aws.amazon.com/s3/">Amazon S3 with Cloudfront - Static file serving</a>: Simple to use and to configure CORS.</p>

				<p><b>Machine Learning Backend Setup</b></p>
				<p>Using existing machine learning resources is largely an exercise in frustration, particularly when combined with Heroku.
					The first thing to note is that because of chained dependenceies and the fact that Heroku cannot properly sequentially
					install requirements, a <a href="https://github.com/thenovices/heroku-buildpack-scipy">special buildpack</a> is required to 
					deploy scikit-learn, along with the usage of particular versions of numpy, scipy, and scikit-learn, and a modification
					to the configuration setup for Heroku (changing the stack, etc.).<p>
				<p>Even when Heroku has been properly configured to run scikit-learn, or when running the app locally, 
					scikit learn does not guarantee performance or stability.  It might be worth considering building from scratch, 
					or diving deeper into the package to ensure stability.
					<p>
				<p><b>General Technical Architecture (and caching)</b></p>
				<p>The ideal setup would be to have a well-documented schema that is extremely flexible, on top of which sit a web-scraping application that pulls data from a number of sources and inputs it into models, and a machine learning application which runs all permutations and combinations of possible machine learning algorithms on top of the data on a regular interval. 
					The machine learning application should cache model parameters, so future requests do not need to tediously rerun model fitting algorithms, which could become a resource hog if they are run everytime a client requests a page or a prediction.
					My current setup does not cache models, and will run the full stack (pulling from the database, transforming the data to be put into the models, and fitting the model) every time a machine learning related request is made. 
				</p>
				<p><b>Model Improvements</b></p>
				<p>There are a lot of improvements to be made in my data.  First of all, I do not split training and testing data.
				It would be wise to split my data into groups to verify that I'm not overfitting my models, or possibly to cross validate by
				splitting my data into k groups, where I run k-1 models that each use the concatenated data from k-1 groups to train and test on
				the remaining group, then compare the model parameters.  If I see large variances of coefficient values of models in this 
				cross validating method, it's likely the case that I'm overfitting and the model I'm using is not robust.  Since I have 3 possible
				top-level model types with 2 binary options to include, I have 12 total models, which could be see as p-value fishing.
				</p>
				<p>
				To find the best model between large groups of models, it would be a good idea to choose models that are more robust, even if on average
				they might not be as accurate.  My current architecture doesn't support the programatic determination or visualization of model quality.
				</p>
				<p>Lastly, I would be interested in more graphical displays of model performance.  For example, for each attribute I'd be interested in a histogram or scatterplot of the average price difference (y-axis) by the attribute value (x-axis).  This can help us understand underlying model properties, such as the distribution of attributes relative to price given the model, homoscedasticity, and the functions that relate properties to price (linear, log, etc.).</p>
			</div>
		</div>
	</div>
	<!-- /Technical Notes page --> 
</body>
